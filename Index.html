<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pym Write</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Welcome to Pym Write</h3>
            <p>Enter your OpenRouter API key to enable AI writing assistance:</p>
            <input type="password" id="apiKeyInput" placeholder="sk-or-...">
            <p style="font-size:13px; color:#666;">
                <strong>Get your API key:</strong> <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a><br>
                Your key is encrypted and stored locally.
            </p>
            <div class="modal-buttons">
                <button onclick="setApiKey()" class="primary-btn">Save & Continue</button>
                <button onclick="skipApiKey()" class="secondary-btn">Skip (Write Only)</button>
            </div>
        </div>
    </div>

    <!-- Top Bar -->
    <div id="top-bar">
        <div class="hamburger" id="hamburger">
            <span></span><span></span><span></span>
        </div>
        <h1>üìö Pym Write</h1>
        <div class="word-count-display">
            <span id="wordCount">0</span> words
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay"></div>

    <!-- Left Menu -->
    <nav id="menu" class="menu">
        <button onclick="openNewProjectModal(); closeMenu()">üìù New Project</button>
        <button onclick="createBackup(); closeMenu()">üíæ Export Backup</button>
        <label class="file-input-label">
            <input type="file" id="restoreFile" accept=".pym" onchange="restoreFromBackup(this.files[0])" style="display:none;">
            üì• Import Backup
        </label>
        <button onclick="openSettingsModal(); closeMenu()">‚öôÔ∏è Settings</button>
    </nav>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('write')">‚úèÔ∏è Write</button>
            <button class="tab-btn" onclick="switchTab('projects')">üìñ Projects</button>
        </div>

        <!-- Write Tab -->
        <div id="write-tab" class="tab-content active">
            <div class="editor-layout-new">
                <!-- Left Sidebar - Documents & AI -->
                <aside class="sidebar-panel">
                    <div class="sidebar-header">
                        <select id="projectSelect" onchange="switchProject()">
                            <option value="">No Project Selected</option>
                        </select>
                        <button class="icon-btn" onclick="openNewDocumentModal()" title="New Document">‚ûï</button>
                    </div>

                    <!-- Sidebar Tabs -->
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab-btn active" onclick="switchSidebarTab('documents')">üìÑ Documents</button>
                        <button class="sidebar-tab-btn" onclick="switchSidebarTab('ai')">ü§ñ AI Assistant</button>
                    </div>

                    <!-- Documents Tab -->
                    <div id="sidebar-documents-tab" class="sidebar-tab-content active">
                        <div id="documentsList" class="documents-list"></div>
                    </div>

                    <!-- AI Assistant Tab -->
                    <div id="sidebar-ai-tab" class="sidebar-tab-content">
                        <div class="ai-panel-content">
                            <div class="ai-controls">
                                <label>
                                    Model:
                                    <div style="display: flex; gap: 8px; margin-top: 6px;">
                                        <select id="modelSelect" style="flex: 1;">
                                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                        </select>
                                        <button id="favoriteBtn" class="icon-btn" onclick="toggleFavoriteModel()" title="Add to favorites">‚òÜ</button>
                                    </div>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="showFavoritesOnly" onchange="toggleFavoritesFilter()">
                                    <span>Show favorites only</span>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="showFreeOnly" onchange="toggleFavoritesFilter()">
                                    <span>Show free models only</span>
                                </label>

                                <label>
                                    Tokens to Generate:
                                    <select id="tokensToGenerate">
                                        <option value="512">Micro (512)</option>
                                        <option value="1024">Very Short (1024)</option>
                                        <option value="2048">Short (2048)</option>
                                        <option value="4096" selected>Average (4096)</option>
                                        <option value="8192">Above Average (8192)</option>
                                        <option value="16384">Long (16384)</option>
                                        <option value="32768">Very Long (32768)</option>
                                        <option value="65536">Max (65536)</option>
                                        <option value="131072">Super Max (131072)</option>
                                    </select>
                                </label>

                                <label>
                                    Temperature (Creativity):
                                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                                    <span id="temperatureValue">0.7</span>
                                </label>
                            </div>

                            <div class="ai-output" id="aiOutput" style="display:none;">
                                <div class="ai-output-header">
                                    <h4>AI Suggestion</h4>
                                    <button onclick="closeAiOutput()" class="close-btn">‚úï</button>
                                </div>
                                <div class="ai-output-content" id="aiOutputContent"></div>
                                <div class="ai-output-actions">
                                    <button onclick="insertAiText()" class="primary-btn">‚úÖ Insert</button>
                                    <button onclick="copyAiText()" class="secondary-btn">üìã Copy</button>
                                </div>
                            </div>

                            <div class="ai-context">
                                <h4>Context for AI</h4>
                                <textarea id="contextNotes" placeholder="Add notes about your story, characters, or plot to help the AI understand your narrative..."></textarea>
                                <p class="context-hint">üí° Tip: Toggle documents to include them automatically!</p>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Editor Section -->
                <section class="editor-panel-new">
                    <div class="document-info" id="documentInfo" style="display:none;">
                        <div class="document-info-header">
                            <div>
                                <span class="document-type-badge" id="documentType">Document</span>
                                <h2 id="documentTitle">Document Title</h2>
                            </div>
                            <div class="document-meta">
                                <span id="documentWordCount">0 words</span>
                            </div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="continueStory()" id="continueBtn" title="Continue Story">
                            <span class="toolbar-icon">‚ú®</span>
                            <span class="toolbar-label">Continue</span>
                        </button>
                        <button class="toolbar-btn" onclick="improveText()" title="Improve Selected Text">
                            <span class="toolbar-icon">üîÑ</span>
                            <span class="toolbar-label">Improve</span>
                        </button>
                        <button class="toolbar-btn" onclick="brainstorm()" title="Brainstorm Ideas">
                            <span class="toolbar-icon">üí°</span>
                            <span class="toolbar-label">Brainstorm</span>
                        </button>
                        <button class="toolbar-btn" onclick="previewAiRequest()" title="Preview API Request">
                            <span class="toolbar-icon">üëÅÔ∏è</span>
                            <span class="toolbar-label">Preview</span>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn" onclick="convertMarkdownToRichText()" title="Convert Markdown to Rich Text">
                            <span class="toolbar-icon">üìù</span>
                            <span class="toolbar-label">MD‚ÜíRich</span>
                        </button>
                        <button class="toolbar-btn" onclick="formatForFiction()" title="Format for Fiction (Indented Paragraphs)">
                            <span class="toolbar-icon">üìñ</span>
                            <span class="toolbar-label">Fiction</span>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn" onclick="saveDocument()" title="Save Document">
                            <span class="toolbar-icon">üíæ</span>
                            <span class="toolbar-label">Save</span>
                        </button>
                        <button class="toolbar-btn" onclick="clearEditor()" title="Clear Editor">
                            <span class="toolbar-icon">üóëÔ∏è</span>
                            <span class="toolbar-label">Clear</span>
                        </button>
                    </div>

                    <div class="editor-container-new">
                        <div id="editor"></div>
                            <!-- Floating Continue Button -->
                            <div id="floatingContinueBtn" class="floating-continue-btn" style="display:none;" onclick="continueFromCursor()">
                                <span class="btn-text">‚ú® Continue from here</span>
                                <span class="btn-spinner" style="display:none;">‚è≥ Generating...</span>
                            </div>

                            <!-- Floating GO Button -->
                            <div id="floatingGoBtn" class="floating-go-btn" style="display:none;" onclick="startFromScratch()">
                                <span class="btn-text">üöÄ Go ‚Äì Start writing</span>
                                <span class="btn-spinner" style="display:none;">‚≠Æ Generating...</span>
                            </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content">
            <section class="card">
                <h2>Your Projects</h2>
                <button onclick="openNewProjectModal()" class="primary-btn" style="margin-bottom: 20px;">
                    ‚ûï Create New Project
                </button>
                <div id="projectsList"></div>
            </section>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Create New Project</h3>
            <form id="newProjectForm" onsubmit="createProject(event)">
                <label>
                    Project Title:
                    <input type="text" id="newProjectTitle" placeholder="My Novel" required>
                </label>
                <label>
                    Genre:
                    <select id="newProjectGenre">
                        <option value="Fiction">Fiction</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Science Fiction">Science Fiction</option>
                        <option value="Mystery">Mystery</option>
                        <option value="Romance">Romance</option>
                        <option value="Thriller">Thriller</option>
                        <option value="Horror">Horror</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Other">Other</option>
                    </select>
                </label>
                <label>
                    Description:
                    <textarea id="newProjectDescription" placeholder="Brief description of your project..." rows="3"></textarea>
                </label>
                <label>
                    Target Word Count:
                    <input type="number" id="newProjectWordCount" placeholder="50000" min="0" step="1000">
                </label>
                <div class="modal-buttons">
                    <button type="submit" class="primary-btn">Create Project</button>
                    <button type="button" onclick="closeNewProjectModal()" class="secondary-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Document Modal -->
    <div id="newDocumentModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3 id="documentModalTitle">Create New Document</h3>
            <form id="newDocumentForm" onsubmit="createDocument(event)">
                <label>
                    Document Title:
                    <input type="text" id="newDocumentTitle" placeholder="Chapter 1: The Beginning" required>
                </label>
                <label>
                    Document Type:
                    <select id="newDocumentType">
                        <option value="Chapter">Chapter</option>
                        <option value="Instructions">Instructions</option>
                        <option value="Synopsis">Synopsis</option>
                        <option value="Writing Style">Writing Style</option>
                        <option value="Characters">Characters</option>
                        <option value="Locations">Locations</option>
                        <option value="Worldbuilding">Worldbuilding</option>
                        <option value="Plot">Plot</option>
                        <option value="Research">Research</option>
                        <option value="Notes">Notes</option>
                        <option value="Other">Other</option>
                    </select>
                </label>
                <div class="modal-buttons">
                    <button type="submit" class="primary-btn">Create Document</button>
                    <button type="button" onclick="closeNewDocumentModal()" class="secondary-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display:none;">
        <div class="modal-content settings-modal">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="settings-section">
                <h4>Appearance</h4>
                <label>
                    Theme:
                    <select id="themeSelect" onchange="saveSettings()">
                        <option value="default">Modern Purple</option>
                        <option value="typewriter">Typewriter</option>
                        <option value="ocean">Ocean Blue</option>
                        <option value="forest">Forest Green</option>
                        <option value="sunset">Sunset Orange</option>
                        <option value="minimalist">Minimalist Gray</option>
                        <option value="midnight">Midnight Dark</option>
                    </select>
                </label>
                <label>
                    Font Size:
                    <select id="fontSizeSelect" onchange="saveSettings()">
                        <option value="14">Small (14px)</option>
                        <option value="16">Medium (16px)</option>
                        <option value="18">Large (18px)</option>
                        <option value="20">Extra Large (20px)</option>
                    </select>
                </label>
                <label>
                    Auto-save Interval:
                    <select id="autoSaveInterval" onchange="saveSettings()">
                        <option value="30000">30 seconds</option>
                        <option value="60000">1 minute</option>
                        <option value="120000">2 minutes</option>
                        <option value="300000">5 minutes</option>
                    </select>
                </label>
            </div>

            <div class="settings-section">
                <h4>API Configuration</h4>
                <label>
                    OpenRouter API Key:
                    <input type="password" id="settingsApiKey" placeholder="sk-or-...">
                    <button onclick="updateApiKey()" class="secondary-btn" style="margin-top: 8px;">Update API Key</button>
                </label>
            </div>

            <div class="settings-section">
                <div class="section-header">
                    <h4>AI Prompts Customization</h4>
                    <button onclick="restoreDefaultPrompts()" class="secondary-btn small-btn">üîÑ Restore Defaults</button>
                </div>
                <p class="settings-hint">Customize the prompts sent to OpenRouter. Use these placeholders:</p>
                <ul class="placeholder-list">
                    <li><code>{TOKENS_TO_GENERATE}</code> - Target token count</li>
                    <li><code>{CONTEXT_NOTES}</code> - Your context notes</li>
                    <li><code>{DOCUMENTS_CONTEXT}</code> - Enabled documents</li>
                    <li><code>{RECENT_TEXT}</code> - Last 4000 characters of your story</li>
                </ul>
                
                <label>
                    System Prompt:
                    <textarea id="customSystemPrompt" rows="8" placeholder="System prompt..."></textarea>
                </label>
                
                <label>
                    User Prompt:
                    <textarea id="customUserPrompt" rows="5" placeholder="User prompt..."></textarea>
                </label>
                
                <button onclick="saveCustomPrompts()" class="primary-btn" style="margin-top: 10px;">üíæ Save Custom Prompts</button>
            </div>

            <div class="modal-buttons">
                <button onclick="closeSettingsModal()" class="secondary-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Request Preview Modal -->
    <div id="requestPreviewModal" class="modal" style="display:none;">
        <div class="modal-content preview-modal">
            <div class="preview-header">
                <h3>üîç Preview</h3>
                <button onclick="closeRequestPreview()" class="close-btn">‚úï</button>
            </div>
            
            <!-- Preview Tabs -->
            <div class="preview-tabs">
                <button class="preview-tab-btn active" data-tab="api" onclick="switchPreviewTab('api')">API Request</button>
                <button class="preview-tab-btn" data-tab="documents" onclick="switchPreviewTab('documents')">Documents Context</button>
            </div>
            
            <!-- API Tab -->
            <div id="preview-api-tab" class="preview-tab-content active">
                <p class="preview-description">This is exactly what will be sent to OpenRouter:</p>
                <div class="preview-code-container">
                    <pre id="requestPreviewContent" class="preview-code"></pre>
                </div>
            </div>
            
            <!-- Documents Tab -->
            <div id="preview-documents-tab" class="preview-tab-content">
                <p class="preview-description">Enabled documents in order (as sent to AI):</p>
                <div class="preview-code-container">
                    <pre id="documentsPreviewContent" class="preview-code"></pre>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button onclick="copyRequestPreview()" class="primary-btn">üìã Copy to Clipboard</button>
                <button onclick="closeRequestPreview()" class="secondary-btn">Close</button>
            </div>
        </div>
    </div>

    <button id="stopGenerationBtn" class="stop-generation-btn" onclick="stopGeneration()" style="display:none;">
        <span class="stop-icon">‚èπ</span>
        <span class="stop-label">Stop Generation</span>
    </button>

    <script src="app.js"></script>
</body>
</html>